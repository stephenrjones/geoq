var Hashtable=function(UNDEFINED){var FUNCTION="function",STRING="string",UNDEF="undefined";if(typeof encodeURIComponent==UNDEF||Array.prototype.splice===UNDEFINED||Object.prototype.hasOwnProperty===UNDEFINED){return null}function toStr(obj){return typeof obj==STRING?obj:""+obj}function hashObject(obj){var hashCode;if(typeof obj==STRING){return obj}else if(typeof obj.hashCode==FUNCTION){hashCode=obj.hashCode();return typeof hashCode==STRING?hashCode:hashObject(hashCode)}else{return toStr(obj)}}function merge(o1,o2){for(var i in o2){if(o2.hasOwnProperty(i)){o1[i]=o2[i]}}}function equals_fixedValueHasEquals(fixedValue,variableValue){return fixedValue.equals(variableValue)}function equals_fixedValueNoEquals(fixedValue,variableValue){return typeof variableValue.equals==FUNCTION?variableValue.equals(fixedValue):fixedValue===variableValue}function createKeyValCheck(kvStr){return function(kv){if(kv===null){throw new Error("null is not a valid "+kvStr)}else if(kv===UNDEFINED){throw new Error(kvStr+" must not be undefined")}}}var checkKey=createKeyValCheck("key"),checkValue=createKeyValCheck("value");function Bucket(hash,firstKey,firstValue,equalityFunction){this[0]=hash;this.entries=[];this.addEntry(firstKey,firstValue);if(equalityFunction!==null){this.getEqualityFunction=function(){return equalityFunction}}}var EXISTENCE=0,ENTRY=1,ENTRY_INDEX_AND_VALUE=2;function createBucketSearcher(mode){return function(key){var i=this.entries.length,entry,equals=this.getEqualityFunction(key);while(i--){entry=this.entries[i];if(equals(key,entry[0])){switch(mode){case EXISTENCE:return true;case ENTRY:return entry;case ENTRY_INDEX_AND_VALUE:return[i,entry[1]]}}}return false}}function createBucketLister(entryProperty){return function(aggregatedArr){var startIndex=aggregatedArr.length;for(var i=0,entries=this.entries,len=entries.length;i<len;++i){aggregatedArr[startIndex+i]=entries[i][entryProperty]}}}Bucket.prototype={getEqualityFunction:function(searchValue){return typeof searchValue.equals==FUNCTION?equals_fixedValueHasEquals:equals_fixedValueNoEquals},getEntryForKey:createBucketSearcher(ENTRY),getEntryAndIndexForKey:createBucketSearcher(ENTRY_INDEX_AND_VALUE),removeEntryForKey:function(key){var result=this.getEntryAndIndexForKey(key);if(result){this.entries.splice(result[0],1);return result[1]}return null},addEntry:function(key,value){this.entries.push([key,value])},keys:createBucketLister(0),values:createBucketLister(1),getEntries:function(destEntries){var startIndex=destEntries.length;for(var i=0,entries=this.entries,len=entries.length;i<len;++i){destEntries[startIndex+i]=entries[i].slice(0)}},containsKey:createBucketSearcher(EXISTENCE),containsValue:function(value){var entries=this.entries,i=entries.length;while(i--){if(value===entries[i][1]){return true}}return false}};function searchBuckets(buckets,hash){var i=buckets.length,bucket;while(i--){bucket=buckets[i];if(hash===bucket[0]){return i}}return null}function getBucketForHash(bucketsByHash,hash){var bucket=bucketsByHash[hash];return bucket&&bucket instanceof Bucket?bucket:null}function Hashtable(){var buckets=[];var bucketsByHash={};var properties={replaceDuplicateKey:true,hashCode:hashObject,equals:null};var arg0=arguments[0],arg1=arguments[1];if(arg1!==UNDEFINED){properties.hashCode=arg0;properties.equals=arg1}else if(arg0!==UNDEFINED){merge(properties,arg0)}var hashCode=properties.hashCode,equals=properties.equals;this.properties=properties;this.put=function(key,value){checkKey(key);checkValue(value);var hash=hashCode(key),bucket,bucketEntry,oldValue=null;bucket=getBucketForHash(bucketsByHash,hash);if(bucket){bucketEntry=bucket.getEntryForKey(key);if(bucketEntry){if(properties.replaceDuplicateKey){bucketEntry[0]=key}oldValue=bucketEntry[1];bucketEntry[1]=value}else{bucket.addEntry(key,value)}}else{bucket=new Bucket(hash,key,value,equals);buckets.push(bucket);bucketsByHash[hash]=bucket}return oldValue};this.get=function(key){checkKey(key);var hash=hashCode(key);var bucket=getBucketForHash(bucketsByHash,hash);if(bucket){var bucketEntry=bucket.getEntryForKey(key);if(bucketEntry){return bucketEntry[1]}}return null};this.containsKey=function(key){checkKey(key);var bucketKey=hashCode(key);var bucket=getBucketForHash(bucketsByHash,bucketKey);return bucket?bucket.containsKey(key):false};this.containsValue=function(value){checkValue(value);var i=buckets.length;while(i--){if(buckets[i].containsValue(value)){return true}}return false};this.clear=function(){buckets.length=0;bucketsByHash={}};this.isEmpty=function(){return!buckets.length};var createBucketAggregator=function(bucketFuncName){return function(){var aggregated=[],i=buckets.length;while(i--){buckets[i][bucketFuncName](aggregated)}return aggregated}};this.keys=createBucketAggregator("keys");this.values=createBucketAggregator("values");this.entries=createBucketAggregator("getEntries");this.remove=function(key){checkKey(key);var hash=hashCode(key),bucketIndex,oldValue=null;var bucket=getBucketForHash(bucketsByHash,hash);if(bucket){oldValue=bucket.removeEntryForKey(key);if(oldValue!==null){if(bucket.entries.length==0){bucketIndex=searchBuckets(buckets,hash);buckets.splice(bucketIndex,1);delete bucketsByHash[hash]}}}return oldValue};this.size=function(){var total=0,i=buckets.length;while(i--){total+=buckets[i].entries.length}return total}}Hashtable.prototype={each:function(callback){var entries=this.entries(),i=entries.length,entry;while(i--){entry=entries[i];callback(entry[0],entry[1])}},equals:function(hashtable){var keys,key,val,count=this.size();if(count==hashtable.size()){keys=this.keys();while(count--){key=keys[count];val=hashtable.get(key);if(val===null||val!==this.get(key)){return false}}return true}return false},putAll:function(hashtable,conflictCallback){var entries=hashtable.entries();var entry,key,value,thisValue,i=entries.length;var hasConflictCallback=typeof conflictCallback==FUNCTION;while(i--){entry=entries[i];key=entry[0];value=entry[1];if(hasConflictCallback&&(thisValue=this.get(key))){value=conflictCallback(key,thisValue,value)}this.put(key,value)}},clone:function(){var clone=new Hashtable(this.properties);clone.putAll(this);return clone}};Hashtable.prototype.toQueryString=function(){var entries=this.entries(),i=entries.length,entry;var parts=[];while(i--){entry=entries[i];parts[i]=encodeURIComponent(toStr(entry[0]))+"="+encodeURIComponent(toStr(entry[1]))}return parts.join("&")};return Hashtable}();(function(){var proto_initIcon=L.Marker.prototype._initIcon;var proto_setPos=L.Marker.prototype._setPos;var oldIE=L.DomUtil.TRANSFORM==="msTransform";L.Marker.addInitHook(function(){var iconAnchor=this.options.icon.options.iconAnchor;if(iconAnchor){iconAnchor=iconAnchor[0]+"px "+iconAnchor[1]+"px"}this.options.rotationOrigin=this.options.rotationOrigin||iconAnchor||"center bottom";this.options.rotationAngle=this.options.rotationAngle||0});L.Marker.include({_initIcon:function(){proto_initIcon.call(this)},_setPos:function(pos){proto_setPos.call(this,pos);if(this.options.rotationAngle){this._icon.style[L.DomUtil.TRANSFORM+"Origin"]=this.options.rotationOrigin;if(oldIE){this._icon.style[L.DomUtil.TRANSFORM]=" rotate("+this.options.rotationAngle+"deg)"}else{this._icon.style[L.DomUtil.TRANSFORM]+=" rotateZ("+this.options.rotationAngle+"deg)"}}},setRotationAngle:function(angle){this.options.rotationAngle=angle;this.update();return this},setRotationOrigin:function(origin){this.options.rotationOrigin=origin;this.update();return this}})})();var OSH={version:"0.0.2"};function expose(){var oldOSH=window.OSH;OSH.noConflict=function(){window.OSH=oldOSH;return this};window.OSH=OSH}if(typeof module==="object"&&typeof module.exports==="object"){module.exports=OSH}else if(typeof define==="function"&&define.amd){define(OSH)}if(typeof window!=="undefined"){expose()}var instance=null;var STATE={NONE:0,BUFFERING:1,READY:2};var Buffer=function(){this.startCurrentTime=null;this.startDataTime=(new Date).getTime();this.endDataTime=null;this.replayFactor=null;this.buffer=new Array;this.clientTable=new Hashtable;this.observers=new Array;this.bufferState=0;this.bufferDelay=0;this.synchronized=true};Buffer.getBufferSingleton=function(){if(instance==null){instance=new Buffer}return instance};Buffer.prototype.setDelay=function(delay){this.bufferDelay=delay};Buffer.prototype.setSynchronized=function(synchronize){this.synchronized=synchronize};Buffer.prototype.setReplayFactor=function(replayFactor){if(replayFactor<=0){this.replayFactor=1}this.replayFactor=replayFactor};Buffer.prototype.addObserver=function(observerCB){this.observers.push(observerCB)};Buffer.prototype.push=function(id,data,timeStamp,type,name){var datum={id:id,data:data,timeStamp:timeStamp};this.buffer.push(datum);this.callbackObservers(type,name,timeStamp,data);if(this.startDataTime>datum.timeStamp){this.startDataTime=datum.timeStamp}if(this.bufferState==STATE.NONE){this.bufferState=STATE.BUFFERING;this.start()}if(this.bufferState==STATE.READY){if(this.synchronized){this.buffer.sort(function(a,b){if(a.timeStamp>b.timeStamp){return 1}if(a.timeStamp<b.timeStamp){return-1}return 0})}if(this.buffer.length==1){this.processNextData()}}};Buffer.prototype.processNextData=function(){var currentEllapsedTime=(new Date).getTime()-this.startCurrentTime;if(this.buffer.length>0){var next=this.buffer[0];var waitTime=-1;if(this.synchronized){waitTime=(next.timeStamp-this.startDataTime)/this.replayFactor-currentEllapsedTime}if(waitTime>0){window.setTimeout(function(){this.callbackData()}.bind(this),waitTime)}else{this.callbackData()}}};Buffer.prototype.callbackData=function(){var next=this.buffer.shift();if(typeof next!="undefined"&&!isNaN(next.timeStamp)){this.clientTable.get(next.id)(next.data)}this.processNextData()};Buffer.prototype.callbackObservers=function(type,name,timeStamp,data){if(this.observers.length>0){var percent=(timeStamp-this.startRealTime)*100/(this.endRealTime-this.startRealTime);for(var i=0;i<this.observers.length;i++){var callback=this.observers[i];callback({percent:percent.toFixed(2),type:type,name:name,timeStamp:timeStamp,received:(new Date).getTime(),data:data})}}};Buffer.prototype.register=function(id,callback){this.clientTable.put(id,callback)};Buffer.prototype.start=function(){window.setTimeout(function(){this.bufferState=STATE.READY;this.startCurrentTime=(new Date).getTime();this.processNextData()}.bind(this),this.bufferDelay)};Buffer.prototype.reset=function(){this.bufferDelay=0;this.startCurrentTime=(new Date).getTime();this.bufferState=STATE.NONE;this.buffer=new Array};var instanceController=null;OSH.Controller=function(){this.table=new Hashtable;this.buffer=Buffer.getBufferSingleton();this.tableEvents=new Hashtable};OSH.Controller.getSingleton=function(){if(instanceController==null){instanceController=new OSH.Controller}return instanceController};OSH.Controller.prototype.setOptions=function(params){if(params.startTime){this.buffer.setStartDate(params.startTime)}if(params.endTime){this.buffer.setEndDate(params.endTime)}if(params.replayFactor){this.buffer.setReplayFactor(params.replayFactor)}if(params.bufferingTime){this.buffer.setDelay(params.bufferingTime)}if(params.synchronizedTime!="undefined"){this.buffer.setSynchronized(params.synchronizedTime)}};OSH.Controller.prototype.addDataSource=function(object,url,name,timeStampParser,callback){var uuid=getUUID();this.table.put(uuid,object);var ws=new WebSocket(url);ws.binaryType="arraybuffer";ws.onmessage=function(event){var timeStamp=(new Date).getTime();if(timeStampParser!=null){timeStamp=timeStampParser(event.data)}this.buffer.push(uuid,event.data,timeStamp,name,name+"-"+uuid)}.bind(this);ws.onerror=function(event){ws.close()};this.buffer.register(uuid,callback);return uuid};OSH.Controller.prototype.addDataSourceObserver=function(observer){this.buffer.addObserver(observer)};function getUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c=="x"?r:r&3|8;return v.toString(16)})}var first=true;OSH.LeafletDataMarker=function(map,group,options){this.map=map;this.group=group;this.pathCoordinates=[];this.marker=L.marker([0,0],options);group.addLayer(this.marker);this.id=this.marker._leaflet_id;this.path=new L.Polyline(this.pathCoordinates,{color:"blue",weight:3,opacity:.5,smoothFactor:1});group.addLayer(this.path);this.bindPopup()};OSH.LeafletDataMarker.prototype.onUpdateLocationData=function(data){var self=this;var rec=String.fromCharCode.apply(null,new Uint8Array(data));var tokens=rec.trim().split(",");var lat=parseFloat(tokens[1]);var lon=parseFloat(tokens[2]);var alt=parseFloat(tokens[3]);if(!isNaN(lon)&&!isNaN(lat)){var newLatLng=new L.LatLng(lat,lon);self.marker.setLatLng(newLatLng);if(first){self.map.setView(self.marker.getLatLng(),self.map.getZoom());first=false}}if(self.pathCoordinates.length>200){self.pathCoordinates.shift()}self.group.removeLayer(self.path);self.pathCoordinates.push(new L.LatLng(lat,lon));var path=new L.Polyline(self.pathCoordinates,{color:"blue",weight:5,opacity:.5,smoothFactor:1});self.group.addLayer(path)};OSH.LeafletDataMarker.prototype.onUpdateOrientationData=function(data){var rec=String.fromCharCode.apply(null,new Uint8Array(data));var tokens=rec.trim().split(",");var qx=parseFloat(tokens[1]);var qy=parseFloat(tokens[2]);var qz=parseFloat(tokens[3]);var qw=parseFloat(tokens[4]);var x=0;var y=0;var z=-1;var ix=qw*x+qy*z-qz*y;var iy=qw*y+qz*x-qx*z;var iz=qw*z+qx*y-qy*x;var iw=-qx*x-qy*y-qz*z;xp=ix*qw+iw*-qx+iy*-qz-iz*-qy;yp=iy*qw+iw*-qy+iz*-qx-ix*-qz;zp=iz*qw+iw*-qz+ix*-qy-iy*-qx;var yaw=90-180/Math.PI*Math.atan2(yp,xp);this.marker.setRotationAngle(yaw)};OSH.LeafletDataMarker.prototype.bindPopup=function(){var videoDivId="video-"+this.id;var div=document.createElement("div");var videoElt='<img id="'+videoDivId+'" class="popup-video" width="250px" height="200px"></img>';div.innerHTML=videoElt;this.marker.bindPopup(div,{offset:new L.Point(0,-16),autoPan:false});this.imgTag=div.firstChild;$(this.imgTag).click(function(){var closeFn=function(event,ui){this.bindPopup()}.bind(this);$("#"+videoDivId).dialog({height:"auto",width:"auto",close:closeFn,dialogClass:"popup-video"});this.marker.closePopup();this.marker.unbindPopup()}.bind(this))};OSH.LeafletDataMarker.prototype.onUpdateVideoData=function(data){var imgBlob=new Blob([data]);var blobURL=window.URL.createObjectURL(imgBlob.slice(12));var oldBlobURL=this.imgTag.src;this.imgTag.src=blobURL;window.URL.revokeObjectURL(oldBlobURL)};var UTCAndroidShiftTime=16*1e3;OSH.TimeStampParser=function(){};OSH.TimeStampParser.parseAndroidText=function(data){var rec=String.fromCharCode.apply(null,new Uint8Array(data));var tokens=rec.trim().split(",");var date=new Date(tokens[0]);return date.getTime()-UTCAndroidShiftTime};OSH.TimeStampParser.parseVideo=function(data){return new DataView(data).getFloat64(0,false)*1e3};L.SOS=L.FeatureGroup.extend({options:{debug:true,replaySpeed:1,icon:new L.Icon.Default},initialize:function(map,options){L.Util.setOptions(this,options);this._layers={};this._map=map;this.loadOffering(map,options)},loadOffering:function(map,options){var controller=OSH.Controller.getSingleton();var url=options.url+"?service=SOS&version=2.0&request=GetResult&offering="+options.offering+"&temporalFilter=phenomenonTime,"+options.timeRange+"&replaySpeed="+options.replaySpeed+"&observedProperty=";var markerOpts={};if(options.style)markerOpts.icon=L.icon(options.style);var dataMarker=new OSH.LeafletDataMarker(map,this,markerOpts);if(options.locationProp)controller.addDataSource(this,url+options.locationProp,options.id+"_loc",OSH.TimeStampParser.parseAndroidText,dataMarker.onUpdateLocationData.bind(dataMarker));if(options.orientationProp)controller.addDataSource(this,url+options.orientationProp,options.id+"_rot",OSH.TimeStampParser.parseAndroidText,dataMarker.onUpdateOrientationData.bind(dataMarker));if(options.videoProp)controller.addDataSource(this,url+options.videoProp,options.id+"_vid",OSH.TimeStampParser.parseVideo,dataMarker.onUpdateVideoData.bind(dataMarker))},sosLayerGroup:L.layerGroup(),layer_ids:{}});